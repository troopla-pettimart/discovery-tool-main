<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project · Discovery & Strategy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Optional: external stylesheet -->
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    .page-wrapper {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    .card {
      background: radial-gradient(circle at top left, #1e293b, #020617);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 24px 20px 28px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.7);
    }
    nav.breadcrumb {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    nav.breadcrumb a {
      color: #e5e7eb;
      text-decoration: none;
    }
    nav.breadcrumb a:hover {
      text-decoration: underline;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: transparent;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .back-btn:hover {
      background: rgba(15, 23, 42, 0.9);
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }
    .project-title {
      font-size: 1.6rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .project-meta {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .pill-small {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 4px;
    }
    .pill-small .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }
    .summary-block {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.85);
      font-size: 0.85rem;
      color: #d1d5db;
      white-space: pre-wrap;
    }
    .summary-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    .progress-text {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .progress-bar {
      position: relative;
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.4);
      overflow: hidden;
    }
    .progress-bar-inner {
      position: absolute;
      inset: 0;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(to right, #4f46e5, #6366f1);
      transition: width 0.3s ease-out;
    }
    .modules-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 20px;
    }
    @media (min-width: 768px) {
      .modules-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .module-card {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.9);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, border-color 0.1s ease-out;
    }
    .module-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
      border-color: rgba(129, 140, 248, 0.9);
    }
    .module-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .module-title {
      font-size: 0.98rem;
      font-weight: 500;
    }
    .module-tag {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .module-desc {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .module-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .status-pill {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-pill.completed {
      border-color: rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
    }
    .status-pill.pending {
      border-color: rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .status-dot.completed {
      background: #22c55e;
    }
    .status-dot.pending {
      background: #fbbf24;
    }
    .open-link {
      font-size: 0.8rem;
      color: #a5b4fc;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .open-link span.arrow {
      font-size: 0.9rem;
    }
    .status-message {
      font-size: 0.8rem;
      margin-top: 8px;
      color: #9ca3af;
    }
    .status-message.error {
      color: #f97373;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Breadcrumb + back -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;">
      <nav class="breadcrumb" id="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span>/</span>
        <span id="breadcrumb-project">Project</span>
      </nav>
      <button type="button" class="back-btn" id="backToDashboardBtn">
        ← Back to dashboard
      </button>
    </div>

    <div class="card">
      <div class="header-row">
        <div>
          <div class="project-title" id="projectName">Loading project…</div>
          <div class="project-meta" id="projectMeta">—</div>
        </div>
        <div style="text-align:right;">
          <div class="project-meta" id="projectCreated">—</div>
          <div class="project-meta">
            <span>Modules completion</span>
            <span class="pill-small" id="completionLabel">
              <span class="dot"></span>
              0 / 6
            </span>
          </div>
        </div>
      </div>

      <div>
        <div class="summary-label">Primary goal</div>
        <div class="summary-block" id="summaryGoal">—</div>

        <div class="summary-label" style="margin-top:10px;">Main pains / challenges</div>
        <div class="summary-block" id="summaryPains">—</div>
      </div>

      <div class="progress-row">
        <div class="progress-text" id="progressText">Discovery & strategy progress</div>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progressBarInner"></div>
        </div>
      </div>

      <div class="modules-grid" id="modulesGrid">
        <!-- Cards se generan por JS -->
      </div>

      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase client setup ===
    const SUPABASE_URL = "https://reezovhnmonzaafhigjz.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZXpvdmhubW9uemFhZmhpZ2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NTQ5ODUsImV4cCI6MjA4MDEzMDk4NX0.J2qSIoj9-bGgrPtHN3oowAGQ2yw_c3GymMH9-ljTsnM";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const backToDashboardBtn = document.getElementById("backToDashboardBtn");
    const breadcrumbProject = document.getElementById("breadcrumb-project");

    const projectNameEl = document.getElementById("projectName");
    const projectMetaEl = document.getElementById("projectMeta");
    const projectCreatedEl = document.getElementById("projectCreated");
    const summaryGoalEl = document.getElementById("summaryGoal");
    const summaryPainsEl = document.getElementById("summaryPains");
    const completionLabelEl = document.getElementById("completionLabel");
    const progressBarInnerEl = document.getElementById("progressBarInner");
    const modulesGridEl = document.getElementById("modulesGrid");
    const statusEl = document.getElementById("statusMessage");

    let currentProjectId = null;
    let currentProjectData = null;

    function setStatus(message, isError = false) {
      if (!statusEl) return;
      statusEl.textContent = message || "";
      statusEl.classList.toggle("error", !!isError);
    }

    function getProjectIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("projectId");
    }

    function isObjectNonEmpty(obj) {
      if (!obj || typeof obj !== "object") return false;
      return Object.values(obj).some(v => {
        if (v === null || v === undefined) return false;
        if (typeof v === "string" && v.trim() === "") return false;
        return true;
      });
    }

    function computeModuleStatus(project) {
      const statuses = [];

      // Intake
      const intakeComplete = isObjectNonEmpty(project.intake);
      statuses.push({
        key: "intake",
        name: "Discovery · Intake",
        tag: "Context & goals",
        description: "Context, goals, constraints and previous attempts.",
        completed: intakeComplete,
        url: "discovery-intake.html"
      });

      // Audiences
      const audiencesComplete = isObjectNonEmpty(project.audiences);
      statuses.push({
        key: "audiences",
        name: "Discovery · Audiences",
        tag: "Who decides & uses",
        description: "ICP, decision makers, influencers, end users and segmentation.",
        completed: audiencesComplete,
        url: "discovery-audiencias.html"
      });

      // JTBD
      const jtbdComplete = project.jtbd && Array.isArray(project.jtbd.items) && project.jtbd.items.length > 0;
      statuses.push({
        key: "jtbd",
        name: "Discovery · JTBD",
        tag: "Jobs to Be Done",
        description: "Jobs, contexts, outcomes and emotional layers.",
        completed: jtbdComplete,
        url: "discovery-jtbd.html"
      });

      // Tensions
      const tensionsComplete = isObjectNonEmpty(project.tensions);
      statuses.push({
        key: "tensions",
        name: "Discovery · Tensions",
        tag: "Structural frictions",
        description: "Tensions, root causes, workarounds and narrative hooks.",
        completed: tensionsComplete,
        url: "discovery-tensiones.html"
      });

      // Strategy – Value
      const strategyValueComplete = isObjectNonEmpty(project.strategy_value);
      statuses.push({
        key: "strategy_value",
        name: "Strategy · Value",
        tag: "Value proposition",
        description: "Target segment, problem, promise, differentiation and proof.",
        completed: strategyValueComplete,
        url: "strategy-valor.html"
      });

      // Roadmap
      const roadmapComplete = isObjectNonEmpty(project.roadmap);
      statuses.push({
        key: "roadmap",
        name: "Strategy · Roadmap",
        tag: "Roadmap & experiments",
        description: "Horizons, experiments, risks and governance.",
        completed: roadmapComplete,
        url: "roadmap.html"
      });

      // Report (no completion, depende de lo demás)
      const completedCount = statuses.filter(s => s.completed).length;
      const reportEnabled = completedCount > 0;
      statuses.push({
        key: "report",
        name: "Report",
        tag: "Executive view",
        description: "Consolidated view of discovery and strategy. Export to JSON or clipboard.",
        completed: reportEnabled,
        url: "reportes.html",
        isReport: true
      });

      return statuses;
    }

    function renderModules(statuses) {
      modulesGridEl.innerHTML = "";

      statuses.forEach(status => {
        const card = document.createElement("div");
        card.className = "module-card";

        card.addEventListener("click", () => {
          if (!currentProjectId) return;
          const targetUrl = `${status.url}?projectId=${encodeURIComponent(currentProjectId)}`;
          window.location.href = targetUrl;
        });

        const header = document.createElement("div");
        header.className = "module-header";

        const titleBlock = document.createElement("div");
        const title = document.createElement("div");
        title.className = "module-title";
        title.textContent = status.name;

        const tag = document.createElement("div");
        tag.className = "module-tag";
        tag.textContent = status.tag;

        titleBlock.appendChild(title);
        titleBlock.appendChild(tag);

        const statusPill = document.createElement("div");
        statusPill.className = "status-pill " + (status.completed ? "completed" : "pending");

        const dot = document.createElement("span");
        dot.className = "status-dot " + (status.completed ? "completed" : "pending");

        const label = document.createElement("span");
        label.textContent = status.completed
          ? (status.isReport ? "Ready" : "Completed")
          : (status.isReport ? "Not ready" : "Not started");

        statusPill.appendChild(dot);
        statusPill.appendChild(label);

        header.appendChild(titleBlock);
        header.appendChild(statusPill);

        const desc = document.createElement("div");
        desc.className = "module-desc";
        desc.textContent = status.description;

        const footer = document.createElement("div");
        footer.className = "module-footer";

        const open = document.createElement("div");
        open.className = "open-link";
        open.innerHTML = `<span>Open</span><span class="arrow">↗</span>`;

        footer.appendChild(open);

        card.appendChild(header);
        card.appendChild(desc);
        card.appendChild(footer);

        modulesGridEl.appendChild(card);
      });
    }

    async function loadProject(projectId) {
      setStatus("Loading project…");
      const { data, error } = await supabaseClient
        .from("projects")
        .select("*")
        .eq("id", projectId)
        .single();

      if (error) {
        console.error("Error loading project", error);
        setStatus("Error loading project from Supabase.", true);
        projectNameEl.textContent = "Project not found";
        return null;
      }

      currentProjectData = data;

      // Header
      projectNameEl.textContent = data.name || "Unnamed project";
      const metaParts = [];
      if (data.type) metaParts.push(data.type);
      if (data.stage) metaParts.push(data.stage);
      projectMetaEl.textContent = metaParts.length ? metaParts.join(" · ") : "—";

      if (data.created_at) {
        projectCreatedEl.textContent = "Created: " + new Date(data.created_at).toLocaleString();
      } else {
        projectCreatedEl.textContent = "";
      }

      breadcrumbProject.textContent = data.name || "Project";

      // Summary (from intake if present)
      const intake = data.intake || {};
      summaryGoalEl.textContent = intake.primary_goal && intake.primary_goal.trim()
        ? intake.primary_goal
        : "No primary goal captured yet. Fill it in the Intake module.";
      summaryPainsEl.textContent = intake.main_challenges && intake.main_challenges.trim()
        ? intake.main_challenges
        : "No main pains captured yet. Fill them in the Intake module.";

      // Modules status
      const statuses = computeModuleStatus(data);
      const nonReportModules = statuses.filter(m => !m.isReport);
      const completedCount = nonReportModules.filter(m => m.completed).length;
      const totalCount = nonReportModules.length;

      // Completion label & progress bar
      completionLabelEl.innerHTML = `
        <span class="dot"></span>
        ${completedCount} / ${totalCount}
      `;
      const pct = totalCount ? (completedCount / totalCount) * 100 : 0;
      progressBarInnerEl.style.width = `${pct}%`;

      // Render module cards
      renderModules(statuses);

      setStatus("Project loaded. Choose a module to work on.");
      return data;
    }

    async function init() {
      const projectId = getProjectIdFromURL();
      if (!projectId) {
        setStatus("Missing projectId in URL. Go back to the dashboard and open a project from there.", true);
        projectNameEl.textContent = "No project selected";
        return;
      }
      currentProjectId = projectId;

      // Back to dashboard
      if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener("click", () => {
          window.location.href = "index.html";
        });
      }

      // Breadcrumb project as text (ya se muestra, y cada módulo tiene navegación)
      await loadProject(projectId);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>