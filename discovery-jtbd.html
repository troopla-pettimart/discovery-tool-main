<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Discovery – Jobs to Be Done</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Optional: external stylesheet -->
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    .page-wrapper {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    .card {
      background: radial-gradient(circle at top left, #1e293b, #020617);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 24px 20px 28px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.7);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .card-title span.subtitle {
      font-size: 0.9rem;
      font-weight: 400;
      color: #9ca3af;
    }
    nav.breadcrumb {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    nav.breadcrumb a {
      color: #e5e7eb;
      text-decoration: none;
    }
    nav.breadcrumb a:hover {
      text-decoration: underline;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.75rem;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.9);
    }
    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: transparent;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .back-btn:hover {
      background: rgba(15, 23, 42, 0.9);
    }
    .grid {
      display: grid;
      gap: 16px;
    }
    @media (min-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    textarea, input[type="text"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      padding: 8px 10px;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 40px;
    }
    textarea::placeholder,
    input::placeholder {
      color: #6b7280;
    }
    textarea {
      min-height: 70px;
    }
    .section-title {
      font-size: 0.95rem;
      font-weight: 500;
      margin: 20px 0 4px;
      color: #e5e7eb;
    }
    .section-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      background: linear-gradient(to right, #4f46e5, #6366f1);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-secondary {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary[disabled],
    .btn-secondary[disabled] {
      opacity: 0.6;
      cursor: wait;
    }
    .status-message {
      font-size: 0.8rem;
      margin-top: 8px;
      color: #9ca3af;
    }
    .status-message.error {
      color: #f97373;
    }
    .pill-small {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #9ca3af;
    }
    .jobs-list {
      margin-top: 24px;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
      padding-top: 16px;
    }
    .job-card {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      padding: 12px 12px 10px;
      margin-bottom: 10px;
    }
    .job-card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .job-title {
      font-size: 0.95rem;
      font-weight: 500;
      color: #e5e7eb;
    }
    .job-meta {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .job-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .small-btn {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
    }
    .small-btn.danger {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }
    .small-text {
      font-size: 0.8rem;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Breadcrumb + back -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;">
      <nav class="breadcrumb" id="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span>/</span>
        <span id="breadcrumb-project">Project</span>
        <span>/</span>
        <span>Discovery – JTBD</span>
      </nav>
      <button type="button" class="back-btn" id="backToProjectBtn">
        ← Back to project
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span id="projectNameHeading">Discovery – Jobs to Be Done</span>
          <span class="subtitle">
            Capture the jobs, contexts and desired outcomes that shape how this product should behave.
          </span>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
          <span class="pill">
            <span class="dot"></span>
            Discovery · JTBD
          </span>
          <span class="pill-small" id="projectShortInfo">Loading project…</span>
        </div>
      </div>

      <!-- JTBD editor -->
      <form id="jtbdForm">
        <h3 class="section-title">New job</h3>
        <p class="section-subtitle">
          Think of a specific moment in the userʼs life where they “hire” your product to make progress.
        </p>

        <label for="jtbd_title">Job statement</label>
        <input
          type="text"
          id="jtbd_title"
          name="jtbd_title"
          placeholder="When [situation], I want to [progress], so I can [outcome]."
        />

        <div class="grid grid-cols-2">
          <div>
            <label for="jtbd_situation">Situation / context</label>
            <textarea
              id="jtbd_situation"
              name="jtbd_situation"
              placeholder="Where and when does this happen? Who is there? What tools are already in play?"
            ></textarea>
          </div>
          <div>
            <label for="jtbd_trigger">Trigger</label>
            <textarea
              id="jtbd_trigger"
              name="jtbd_trigger"
              placeholder="What makes them realise they need to act now?"
            ></textarea>
          </div>
        </div>

        <div class="grid grid-cols-2">
          <div>
            <label for="jtbd_outcome">Desired outcome / success</label>
            <textarea
              id="jtbd_outcome"
              name="jtbd_outcome"
              placeholder="How do they know it worked? What is different afterwards?"
            ></textarea>
          </div>
          <div>
            <label for="jtbd_obstacles">Obstacles & anxieties</label>
            <textarea
              id="jtbd_obstacles"
              name="jtbd_obstacles"
              placeholder="Fears, frictions, blockers and internal debates that slow them down."
            ></textarea>
          </div>
        </div>

        <div class="grid grid-cols-2">
          <div>
            <label for="jtbd_alternatives">Current alternatives</label>
            <textarea
              id="jtbd_alternatives"
              name="jtbd_alternatives"
              placeholder="What do they use instead today? Spreadsheets, email, manual processes, competitors…"
            ></textarea>
          </div>
          <div>
            <label for="jtbd_emotional">Emotional layer</label>
            <textarea
              id="jtbd_emotional"
              name="jtbd_emotional"
              placeholder="What does this job mean emotionally? Status, safety, reputation, peace of mind, etc."
            ></textarea>
          </div>
        </div>

        <label for="jtbd_importance">Importance / priority</label>
        <input
          type="text"
          id="jtbd_importance"
          name="jtbd_importance"
          placeholder="High / Medium / Low, or a 1–5 scale with a short explanation."
        />

        <div class="actions">
          <button type="button" class="btn-secondary" id="cancelEditBtn" style="display:none;">
            Cancel edit
          </button>
          <button type="submit" class="btn-primary" id="saveJobBtn">
            Add job
          </button>
        </div>
        <div id="statusMessage" class="status-message"></div>
      </form>

      <!-- JTBD list -->
      <div class="jobs-list">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
          <h3 class="section-title" style="margin-top:0;">Jobs list</h3>
          <span class="small-text" id="jobsCountLabel">0 jobs</span>
        </div>
        <p class="section-subtitle">
          Each card below represents a job. You can edit or delete them, and theyʼll be used later for strategy and reporting.
        </p>
        <div id="jobsContainer"></div>
      </div>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase client setup ===
    const SUPABASE_URL = "https://reezovhnmonzaafhigjz.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZXpvdmhubW9uemFhZmhpZ2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NTQ5ODUsImV4cCI6MjA4MDEzMDk4NX0.J2qSIoj9-bGgrPtHN3oowAGQ2yw_c3GymMH9-ljTsnM";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("statusMessage");
    const projectNameHeading = document.getElementById("projectNameHeading");
    const projectShortInfo = document.getElementById("projectShortInfo");
    const breadcrumbProject = document.getElementById("breadcrumb-project");
    const backToProjectBtn = document.getElementById("backToProjectBtn");

    const jtbdForm = document.getElementById("jtbdForm");
    const saveJobBtn = document.getElementById("saveJobBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const jobsContainer = document.getElementById("jobsContainer");
    const jobsCountLabel = document.getElementById("jobsCountLabel");

    let currentProjectId = null;
    let jtbdItems = [];
    let editingIndex = null; // null = creando, número = editando

    function setStatus(message, isError = false) {
      if (!statusEl) return;
      statusEl.textContent = message || "";
      statusEl.classList.toggle("error", !!isError);
    }

    function setSaving(isSaving) {
      if (!saveJobBtn) return;
      if (isSaving) {
        saveJobBtn.disabled = true;
        cancelEditBtn.disabled = true;
        saveJobBtn.textContent = editingIndex === null ? "Saving…" : "Updating…";
      } else {
        saveJobBtn.disabled = false;
        cancelEditBtn.disabled = false;
        saveJobBtn.textContent = editingIndex === null ? "Add job" : "Update job";
      }
    }

    function getProjectIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("projectId");
    }

    function clearForm() {
      jtbdForm.reset();
      editingIndex = null;
      saveJobBtn.textContent = "Add job";
      cancelEditBtn.style.display = "none";
      setStatus("");
    }

    function fillFormFromItem(item) {
      document.getElementById("jtbd_title").value = item.title || "";
      document.getElementById("jtbd_situation").value = item.situation || "";
      document.getElementById("jtbd_trigger").value = item.trigger || "";
      document.getElementById("jtbd_outcome").value = item.outcome || "";
      document.getElementById("jtbd_obstacles").value = item.obstacles || "";
      document.getElementById("jtbd_alternatives").value = item.alternatives || "";
      document.getElementById("jtbd_emotional").value = item.emotional || "";
      document.getElementById("jtbd_importance").value = item.importance || "";
    }

    function collectFormData() {
      return {
        title: document.getElementById("jtbd_title").value.trim(),
        situation: document.getElementById("jtbd_situation").value.trim(),
        trigger: document.getElementById("jtbd_trigger").value.trim(),
        outcome: document.getElementById("jtbd_outcome").value.trim(),
        obstacles: document.getElementById("jtbd_obstacles").value.trim(),
        alternatives: document.getElementById("jtbd_alternatives").value.trim(),
        emotional: document.getElementById("jtbd_emotional").value.trim(),
        importance: document.getElementById("jtbd_importance").value.trim()
      };
    }

    function renderJobs() {
      jobsContainer.innerHTML = "";

      if (!jtbdItems.length) {
        jobsContainer.innerHTML = '<p class="small-text">No jobs captured yet. Start by adding one above.</p>';
      } else {
        jtbdItems.forEach((job, index) => {
          const card = document.createElement("div");
          card.className = "job-card";

          const header = document.createElement("div");
          header.className = "job-card-header";

          const title = document.createElement("div");
          title.className = "job-title";
          title.textContent = job.title || `Job ${index + 1}`;

          const meta = document.createElement("div");
          meta.className = "job-meta";
          const importance = job.importance ? `Importance: ${job.importance}` : "Importance: –";
          meta.textContent = importance;

          header.appendChild(title);
          header.appendChild(meta);

          const body = document.createElement("div");
          body.className = "small-text";
          const summaryParts = [];
          if (job.situation) summaryParts.push(`Situation: ${job.situation}`);
          if (job.trigger) summaryParts.push(`Trigger: ${job.trigger}`);
          if (job.outcome) summaryParts.push(`Outcome: ${job.outcome}`);
          if (job.alternatives) summaryParts.push(`Alternatives: ${job.alternatives}`);
          body.textContent = summaryParts.join(" · ");

          const actions = document.createElement("div");
          actions.className = "job-actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "small-btn";
          editBtn.textContent = "Edit";
          editBtn.addEventListener("click", () => {
            editingIndex = index;
            fillFormFromItem(job);
            saveJobBtn.textContent = "Update job";
            cancelEditBtn.style.display = "inline-flex";
            setStatus(`Editing job #${index + 1}`);
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "small-btn danger";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", async () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            jtbdItems.splice(index, 1);
            await persistJTBD();
          });

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          card.appendChild(header);
          card.appendChild(body);
          card.appendChild(actions);

          jobsContainer.appendChild(card);
        });
      }

      jobsCountLabel.textContent = `${jtbdItems.length} job${jtbdItems.length === 1 ? "" : "s"}`;
    }

    async function loadProject(projectId) {
      setStatus("Loading project…");
      const { data, error } = await supabaseClient
        .from("projects")
        .select("*")
        .eq("id", projectId)
        .single();

      if (error) {
        console.error("Error loading project", error);
        setStatus("Error loading project from Supabase.", true);
        return null;
      }

      // Header info
      projectNameHeading.textContent = data.name || "Discovery – Jobs to Be Done";
      projectShortInfo.textContent =
        (data.stage ? `${data.stage} · ` : "") +
        (data.type || "Project") +
        (data.created_at ? ` · ${new Date(data.created_at).toLocaleDateString()}` : "");

      breadcrumbProject.textContent = data.name || "Project";

      // JTBD items
      if (data.jtbd && typeof data.jtbd === "object" && Array.isArray(data.jtbd.items)) {
        jtbdItems = data.jtbd.items;
      } else {
        jtbdItems = [];
      }

      renderJobs();
      setStatus("Project loaded. You can now add or edit jobs.");
      return data;
    }

    async function persistJTBD() {
      if (!currentProjectId) return;
      setSaving(true);
      setStatus("");

      const payload = {
        items: jtbdItems,
        updated_at: new Date().toISOString()
      };

      const { error } = await supabaseClient
        .from("projects")
        .update({ jtbd: payload })
        .eq("id", currentProjectId);

      setSaving(false);

      if (error) {
        console.error("Error saving JTBD", error);
        setStatus("Error saving JTBD. Please try again.", true);
        return;
      }

      renderJobs();
      clearForm();
      setStatus("JTBD saved ✔️");
      setTimeout(() => setStatus(""), 3000);
    }

    async function init() {
      const projectId = getProjectIdFromURL();
      if (!projectId) {
        setStatus("Missing projectId in URL. Go back to the dashboard and open a project from there.", true);
        return;
      }
      currentProjectId = projectId;

      // Back button
      if (backToProjectBtn) {
        backToProjectBtn.addEventListener("click", () => {
          window.location.href = `project.html?projectId=${encodeURIComponent(projectId)}`;
        });
      }

      // Make breadcrumb project clickable
      const breadcrumbProjectLink = document.createElement("a");
      breadcrumbProjectLink.href = `project.html?projectId=${encodeURIComponent(projectId)}`;
      breadcrumbProjectLink.textContent = "Project";
      if (breadcrumbProject && breadcrumbProject.parentNode) {
        breadcrumbProject.replaceWith(breadcrumbProjectLink);
      }

      const project = await loadProject(projectId);
      if (!project) return;

      // Form submit
      if (jtbdForm) {
        jtbdForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const job = collectFormData();

          if (!job.title) {
            setStatus("Please add at least a job statement title.", true);
            return;
          }

          if (editingIndex === null) {
            jtbdItems.push(job);
          } else {
            jtbdItems[editingIndex] = job;
          }

          await persistJTBD();
        });
      }

      // Cancel edit
      if (cancelEditBtn) {
        cancelEditBtn.addEventListener("click", () => {
          clearForm();
        });
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>