<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Project Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Optional: external stylesheet -->
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    .page-wrapper {
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    .card {
      background: radial-gradient(circle at top left, #1e293b, #020617);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 24px 20px 28px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.7);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .card-title span.subtitle {
      font-size: 0.9rem;
      font-weight: 400;
      color: #9ca3af;
    }
    nav.breadcrumb {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    nav.breadcrumb a {
      color: #e5e7eb;
      text-decoration: none;
    }
    nav.breadcrumb a:hover {
      text-decoration: underline;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.75rem;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.9);
    }
    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: transparent;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .back-btn:hover {
      background: rgba(15, 23, 42, 0.9);
    }
    .pill-small {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #9ca3af;
    }
    .section-title {
      font-size: 0.95rem;
      font-weight: 500;
      margin: 20px 0 4px;
      color: #e5e7eb;
    }
    .section-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .section-block {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.8);
    }
    .section-block h4 {
      font-size: 0.85rem;
      font-weight: 500;
      margin: 0 0 4px;
      color: #e5e7eb;
    }
    .section-block p {
      font-size: 0.8rem;
      color: #d1d5db;
      margin: 0 0 4px;
      white-space: pre-wrap;
    }
    .small-label {
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .status-message {
      font-size: 0.8rem;
      margin-top: 8px;
      color: #9ca3af;
    }
    .status-message.error {
      color: #f97373;
    }
    .btn-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .btn-primary,
    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: linear-gradient(to right, #4f46e5, #6366f1);
      color: white;
    }
    .btn-secondary {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .btn-primary[disabled],
    .btn-secondary[disabled] {
      opacity: 0.6;
      cursor: wait;
    }
    .jobs-list {
      margin-top: 8px;
    }
    .job-card {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      padding: 10px 12px;
      margin-bottom: 8px;
    }
    .job-card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }
    .job-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: #e5e7eb;
    }
    .job-meta {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .job-body {
      font-size: 0.8rem;
      color: #d1d5db;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Breadcrumb + back -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;">
      <nav class="breadcrumb" id="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span>/</span>
        <span id="breadcrumb-project">Project</span>
        <span>/</span>
        <span>Report</span>
      </nav>
      <button type="button" class="back-btn" id="backToProjectBtn">
        ← Back to project
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span id="projectNameHeading">Project Report</span>
          <span class="subtitle">
            Consolidated view of discovery and strategy for this project.
          </span>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
          <span class="pill">
            <span class="dot"></span>
            Report · Overview
          </span>
          <span class="pill-small" id="projectShortInfo">Loading project…</span>
        </div>
      </div>

      <div class="btn-bar">
        <button type="button" class="btn-primary" id="copySummaryBtn">
          Copy text summary
        </button>
        <button type="button" class="btn-secondary" id="downloadJsonBtn">
          Download JSON
        </button>
      </div>
      <div id="statusMessage" class="status-message"></div>

      <!-- SUMMARY SECTION -->
      <div>
        <h3 class="section-title">Summary</h3>
        <p class="section-subtitle">
          High-level snapshot of context, audiences, jobs, tensions, strategy and roadmap.
        </p>
        <div class="section-block">
          <h4>Project basics</h4>
          <p id="summaryBasics">—</p>
        </div>
      </div>

      <!-- INTAKE -->
      <div>
        <h3 class="section-title">Discovery · Intake</h3>
        <p class="section-subtitle">
          Context, goals, constraints and previous attempts.
        </p>
        <div id="reportIntake"></div>
      </div>

      <!-- AUDIENCES -->
      <div>
        <h3 class="section-title">Discovery · Audiences</h3>
        <p class="section-subtitle">
          Who decides, who influences and who uses the product.
        </p>
        <div id="reportAudiences"></div>
      </div>

      <!-- JTBD -->
      <div>
        <h3 class="section-title">Discovery · Jobs to Be Done</h3>
        <p class="section-subtitle">
          Jobs, contexts and desired outcomes driving how the product should behave.
        </p>
        <div id="reportJTBD"></div>
      </div>

      <!-- TENSIONS -->
      <div>
        <h3 class="section-title">Discovery · Tensions</h3>
        <p class="section-subtitle">
          Structural frictions that explain where the organisation gets stuck.
        </p>
        <div id="reportTensions"></div>
      </div>

      <!-- STRATEGY VALUE -->
      <div>
        <h3 class="section-title">Strategy · Value Proposition</h3>
        <p class="section-subtitle">
          Target segment, core problem, promise, differentiation and proof.
        </p>
        <div id="reportStrategyValue"></div>
      </div>

      <!-- ROADMAP -->
      <div>
        <h3 class="section-title">Strategy · Roadmap & Experiments</h3>
        <p class="section-subtitle">
          Horizons, key experiments, risks and governance.
        </p>
        <div id="reportRoadmap"></div>
      </div>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // === Supabase client setup ===
    const SUPABASE_URL = "https://reezovhnmonzaafhigjz.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlZXpvdmhubW9uemFhZmhpZ2p6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NTQ5ODUsImV4cCI6MjA4MDEzMDk4NX0.J2qSIoj9-bGgrPtHN3oowAGQ2yw_c3GymMH9-ljTsnM";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const statusEl = document.getElementById("statusMessage");
    const projectNameHeading = document.getElementById("projectNameHeading");
    const projectShortInfo = document.getElementById("projectShortInfo");
    const breadcrumbProject = document.getElementById("breadcrumb-project");
    const backToProjectBtn = document.getElementById("backToProjectBtn");

    const summaryBasicsEl = document.getElementById("summaryBasics");
    const reportIntakeEl = document.getElementById("reportIntake");
    const reportAudiencesEl = document.getElementById("reportAudiences");
    const reportJTBDEl = document.getElementById("reportJTBD");
    const reportTensionsEl = document.getElementById("reportTensions");
    const reportStrategyValueEl = document.getElementById("reportStrategyValue");
    const reportRoadmapEl = document.getElementById("reportRoadmap");

    const copySummaryBtn = document.getElementById("copySummaryBtn");
    const downloadJsonBtn = document.getElementById("downloadJsonBtn");

    let currentProjectId = null;
    let currentProjectData = null;

    function setStatus(message, isError = false) {
      if (!statusEl) return;
      statusEl.textContent = message || "";
      statusEl.classList.toggle("error", !!isError);
    }

    function getProjectIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("projectId");
    }

    function escapeText(text) {
      if (!text) return "";
      return text;
    }

    function fmt(text) {
      if (!text) return "—";
      return text;
    }

    function renderKeyValueBlock(container, label, value) {
      const block = document.createElement("div");
      block.className = "section-block";

      const title = document.createElement("h4");
      title.textContent = label;

      const p = document.createElement("p");
      p.textContent = value ? value : "—";

      block.appendChild(title);
      block.appendChild(p);
      container.appendChild(block);
    }

    function renderIntake(intake) {
      reportIntakeEl.innerHTML = "";
      if (!intake || typeof intake !== "object") {
        reportIntakeEl.innerHTML = '<p class="section-subtitle">No intake captured yet.</p>';
        return;
      }

      renderKeyValueBlock(reportIntakeEl, "Company / Product", fmt(intake.company_name));
      renderKeyValueBlock(reportIntakeEl, "Main contact", fmt(intake.contact_person));
      renderKeyValueBlock(reportIntakeEl, "Context & background", fmt(intake.context));
      renderKeyValueBlock(reportIntakeEl, "Primary goal", fmt(intake.primary_goal));
      renderKeyValueBlock(reportIntakeEl, "Secondary goals & success criteria", fmt(intake.secondary_goals));
      renderKeyValueBlock(reportIntakeEl, "Main pains / challenges", fmt(intake.main_challenges));
      renderKeyValueBlock(reportIntakeEl, "Constraints", fmt(intake.constraints));
      renderKeyValueBlock(reportIntakeEl, "Team & stakeholders", fmt(intake.team));
      renderKeyValueBlock(reportIntakeEl, "Budget & timeline", fmt(intake.budget_timeline));
      renderKeyValueBlock(reportIntakeEl, "Previous attempts & learnings", fmt(intake.previous_attempts));
      renderKeyValueBlock(reportIntakeEl, "Notes for later", fmt(intake.notes));
    }

    function renderAudiences(audiences) {
      reportAudiencesEl.innerHTML = "";
      if (!audiences || typeof audiences !== "object") {
        reportAudiencesEl.innerHTML = '<p class="section-subtitle">No audiences captured yet.</p>';
        return;
      }

      renderKeyValueBlock(reportAudiencesEl, "Primary audience / ICP", fmt(audiences.primary_audience));
      renderKeyValueBlock(reportAudiencesEl, "Secondary audiences", fmt(audiences.secondary_audiences));
      renderKeyValueBlock(reportAudiencesEl, "Decision makers", fmt(audiences.decision_makers));
      renderKeyValueBlock(reportAudiencesEl, "Influencers & gatekeepers", fmt(audiences.influencers));
      renderKeyValueBlock(reportAudiencesEl, "End users", fmt(audiences.end_users));
      renderKeyValueBlock(reportAudiencesEl, "Segmentation & prioritisation", fmt(audiences.segments));
      renderKeyValueBlock(reportAudiencesEl, "Notes & political landscape", fmt(audiences.notes));
    }

    function renderJTBD(jtbd) {
      reportJTBDEl.innerHTML = "";
      if (!jtbd || typeof jtbd !== "object" || !Array.isArray(jtbd.items) || jtbd.items.length === 0) {
        reportJTBDEl.innerHTML = '<p class="section-subtitle">No jobs captured yet.</p>';
        return;
      }

      const list = document.createElement("div");
      list.className = "jobs-list";

      jtbd.items.forEach((job, index) => {
        const card = document.createElement("div");
        card.className = "job-card";

        const header = document.createElement("div");
        header.className = "job-card-header";

        const title = document.createElement("div");
        title.className = "job-title";
        title.textContent = job.title || `Job ${index + 1}`;

        const meta = document.createElement("div");
        meta.className = "job-meta";
        const parts = [];
        if (job.importance) parts.push(`Importance: ${job.importance}`);
        header.appendChild(title);
        meta.textContent = parts.join(" · ") || "";
        header.appendChild(meta);

        const body = document.createElement("div");
        body.className = "job-body";

        const lines = [];
        if (job.situation) lines.push(`Situation: ${job.situation}`);
        if (job.trigger) lines.push(`Trigger: ${job.trigger}`);
        if (job.outcome) lines.push(`Outcome: ${job.outcome}`);
        if (job.obstacles) lines.push(`Obstacles: ${job.obstacles}`);
        if (job.alternatives) lines.push(`Alternatives: ${job.alternatives}`);
        if (job.emotional) lines.push(`Emotional layer: ${job.emotional}`);

        body.textContent = lines.join("\n");

        card.appendChild(header);
        card.appendChild(body);
        list.appendChild(card);
      });

      reportJTBDEl.appendChild(list);
    }

    function renderTensions(tensions) {
      reportTensionsEl.innerHTML = "";
      if (!tensions || typeof tensions !== "object") {
        reportTensionsEl.innerHTML = '<p class="section-subtitle">No tensions captured yet.</p>';
        return;
      }

      renderKeyValueBlock(reportTensionsEl, "Key tensions", fmt(tensions.tensions));
      renderKeyValueBlock(reportTensionsEl, "Root causes (hypotheses)", fmt(tensions.root_causes));
      renderKeyValueBlock(reportTensionsEl, "Current workarounds", fmt(tensions.workarounds));
      renderKeyValueBlock(reportTensionsEl, "Tensions we won’t touch (for now)", fmt(tensions.non_target));
      renderKeyValueBlock(reportTensionsEl, "Notes & narrative hooks", fmt(tensions.notes));
    }

    function renderStrategyValue(sv) {
      reportStrategyValueEl.innerHTML = "";
      if (!sv || typeof sv !== "object") {
        reportStrategyValueEl.innerHTML = '<p class="section-subtitle">No value strategy captured yet.</p>';
        return;
      }

      renderKeyValueBlock(reportStrategyValueEl, "Target segment", fmt(sv.target_segment));
      renderKeyValueBlock(reportStrategyValueEl, "Core problem / central tension", fmt(sv.core_problem));
      renderKeyValueBlock(reportStrategyValueEl, "Value proposition (promise)", fmt(sv.value_proposition));
      renderKeyValueBlock(reportStrategyValueEl, "Key benefits", fmt(sv.key_benefits));
      renderKeyValueBlock(reportStrategyValueEl, "Differentiation", fmt(sv.differentiation));
      renderKeyValueBlock(reportStrategyValueEl, "Proof points", fmt(sv.proof_points));
      renderKeyValueBlock(reportStrategyValueEl, "Elevator pitch (v1)", fmt(sv.elevator_pitch));
      renderKeyValueBlock(reportStrategyValueEl, "Notes & narrative angles", fmt(sv.notes));
    }

    function renderRoadmap(rm) {
      reportRoadmapEl.innerHTML = "";
      if (!rm || typeof rm !== "object") {
        reportRoadmapEl.innerHTML = '<p class="section-subtitle">No roadmap captured yet.</p>';
        return;
      }

      renderKeyValueBlock(reportRoadmapEl, "Horizon 1 · 0–4 weeks", fmt(rm.short_term));
      renderKeyValueBlock(reportRoadmapEl, "Horizon 2 · 1–3 months", fmt(rm.mid_term));
      renderKeyValueBlock(reportRoadmapEl, "Horizon 3 · 3–12 months", fmt(rm.long_term));
      renderKeyValueBlock(reportRoadmapEl, "Key experiments", fmt(rm.key_experiments));
      renderKeyValueBlock(reportRoadmapEl, "Execution risks & dependencies", fmt(rm.execution_risks));
      renderKeyValueBlock(reportRoadmapEl, "Notes & governance", fmt(rm.notes));
    }

    function buildTextSummary(project) {
      const lines = [];

      lines.push(`# Project: ${project.name || "Unnamed project"}`);
      if (project.stage || project.type) {
        lines.push(
          `Stage/Type: ${project.stage || "-"} / ${project.type || "-"}`
        );
      }
      if (project.created_at) {
        lines.push(`Created at: ${new Date(project.created_at).toLocaleString()}`);
      }
      lines.push("");

      // Intake
      lines.push("## Discovery · Intake");
      const intake = project.intake || {};
      lines.push(`Company / Product: ${fmt(intake.company_name)}`);
      lines.push(`Main contact: ${fmt(intake.contact_person)}`);
      lines.push("");
      lines.push(`Context & background:\n${fmt(intake.context)}`);
      lines.push("");
      lines.push(`Primary goal:\n${fmt(intake.primary_goal)}`);
      lines.push("");
      lines.push(`Secondary goals & success criteria:\n${fmt(intake.secondary_goals)}`);
      lines.push("");
      lines.push(`Main pains / challenges:\n${fmt(intake.main_challenges)}`);
      lines.push("");
      lines.push(`Constraints:\n${fmt(intake.constraints)}`);
      lines.push("");
      lines.push(`Team & stakeholders:\n${fmt(intake.team)}`);
      lines.push("");
      lines.push(`Budget & timeline:\n${fmt(intake.budget_timeline)}`);
      lines.push("");
      lines.push(`Previous attempts:\n${fmt(intake.previous_attempts)}`);
      lines.push("");
      lines.push(`Notes:\n${fmt(intake.notes)}`);
      lines.push("");

      // Audiences
      lines.push("## Discovery · Audiences");
      const aud = project.audiences || {};
      lines.push(`Primary audience / ICP:\n${fmt(aud.primary_audience)}`);
      lines.push("");
      lines.push(`Secondary audiences:\n${fmt(aud.secondary_audiences)}`);
      lines.push("");
      lines.push(`Decision makers:\n${fmt(aud.decision_makers)}`);
      lines.push("");
      lines.push(`Influencers & gatekeepers:\n${fmt(aud.influencers)}`);
      lines.push("");
      lines.push(`End users:\n${fmt(aud.end_users)}`);
      lines.push("");
      lines.push(`Segmentation & prioritisation:\n${fmt(aud.segments)}`);
      lines.push("");
      lines.push(`Notes & political landscape:\n${fmt(aud.notes)}`);
      lines.push("");

      // JTBD
      lines.push("## Discovery · Jobs to Be Done");
      const jtbd = project.jtbd && Array.isArray(project.jtbd.items)
        ? project.jtbd.items
        : [];
      if (!jtbd.length) {
        lines.push("No jobs captured.");
      } else {
        jtbd.forEach((job, idx) => {
          lines.push(`### Job ${idx + 1}: ${job.title || "(no title)"}`);
          lines.push(`Situation: ${fmt(job.situation)}`);
          lines.push(`Trigger: ${fmt(job.trigger)}`);
          lines.push(`Outcome: ${fmt(job.outcome)}`);
          lines.push(`Obstacles: ${fmt(job.obstacles)}`);
          lines.push(`Alternatives: ${fmt(job.alternatives)}`);
          lines.push(`Emotional: ${fmt(job.emotional)}`);
          lines.push(`Importance: ${fmt(job.importance)}`);
          lines.push("");
        });
      }
      lines.push("");

      // Tensions
      lines.push("## Discovery · Tensions");
      const t = project.tensions || {};
      lines.push(`Key tensions:\n${fmt(t.tensions)}`);
      lines.push("");
      lines.push(`Root causes:\n${fmt(t.root_causes)}`);
      lines.push("");
      lines.push(`Current workarounds:\n${fmt(t.workarounds)}`);
      lines.push("");
      lines.push(`Out-of-scope tensions:\n${fmt(t.non_target)}`);
      lines.push("");
      lines.push(`Notes & narrative hooks:\n${fmt(t.notes)}`);
      lines.push("");

      // Strategy value
      lines.push("## Strategy · Value Proposition");
      const sv = project.strategy_value || {};
      lines.push(`Target segment:\n${fmt(sv.target_segment)}`);
      lines.push("");
      lines.push(`Core problem:\n${fmt(sv.core_problem)}`);
      lines.push("");
      lines.push(`Value proposition:\n${fmt(sv.value_proposition)}`);
      lines.push("");
      lines.push(`Key benefits:\n${fmt(sv.key_benefits)}`);
      lines.push("");
      lines.push(`Differentiation:\n${fmt(sv.differentiation)}`);
      lines.push("");
      lines.push(`Proof points:\n${fmt(sv.proof_points)}`);
      lines.push("");
      lines.push(`Elevator pitch:\n${fmt(sv.elevator_pitch)}`);
      lines.push("");
      lines.push(`Notes & narrative angles:\n${fmt(sv.notes)}`);
      lines.push("");

      // Roadmap
      lines.push("## Strategy · Roadmap & Experiments");
      const rm = project.roadmap || {};
      lines.push(`Horizon 1 (0–4 weeks):\n${fmt(rm.short_term)}`);
      lines.push("");
      lines.push(`Horizon 2 (1–3 months):\n${fmt(rm.mid_term)}`);
      lines.push("");
      lines.push(`Horizon 3 (3–12 months):\n${fmt(rm.long_term)}`);
      lines.push("");
      lines.push(`Key experiments:\n${fmt(rm.key_experiments)}`);
      lines.push("");
      lines.push(`Execution risks & dependencies:\n${fmt(rm.execution_risks)}`);
      lines.push("");
      lines.push(`Notes & governance:\n${fmt(rm.notes)}`);
      lines.push("");

      return lines.join("\n");
    }

    async function loadProject(projectId) {
      setStatus("Loading project…");
      const { data, error } = await supabaseClient
        .from("projects")
        .select("*")
        .eq("id", projectId)
        .single();

      if (error) {
        console.error("Error loading project", error);
        setStatus("Error loading project from Supabase.", true);
        return null;
      }

      currentProjectData = data;

      // Header
      projectNameHeading.textContent = data.name || "Project Report";
      projectShortInfo.textContent =
        (data.stage ? `${data.stage} · ` : "") +
        (data.type || "Project") +
        (data.created_at ? ` · ${new Date(data.created_at).toLocaleDateString()}` : "");

      breadcrumbProject.textContent = data.name || "Project";

      // Summary basics
      const basicsLines = [];
      basicsLines.push(`Name: ${data.name || "—"}`);
      if (data.type) basicsLines.push(`Type: ${data.type}`);
      if (data.stage) basicsLines.push(`Stage: ${data.stage}`);
      if (data.intake && data.intake.primary_goal) {
        basicsLines.push(`Primary goal: ${data.intake.primary_goal}`);
      }
      if (data.intake && data.intake.main_challenges) {
        basicsLines.push(`Main challenges: ${data.intake.main_challenges}`);
      }
      summaryBasicsEl.textContent = basicsLines.join("\n");

      // Render sections
      renderIntake(data.intake);
      renderAudiences(data.audiences);
      renderJTBD(data.jtbd);
      renderTensions(data.tensions);
      renderStrategyValue(data.strategy_value);
      renderRoadmap(data.roadmap);

      setStatus("Project loaded. Report ready.");
      return data;
    }

    function setupButtons() {
      if (copySummaryBtn) {
        copySummaryBtn.addEventListener("click", async () => {
          if (!currentProjectData) {
            setStatus("No project loaded to copy summary.", true);
            return;
          }
          try {
            const text = buildTextSummary(currentProjectData);
            await navigator.clipboard.writeText(text);
            setStatus("Summary copied to clipboard ✔️");
            setTimeout(() => setStatus(""), 3000);
          } catch (err) {
            console.error(err);
            setStatus("Could not copy to clipboard. Check browser permissions.", true);
          }
        });
      }

      if (downloadJsonBtn) {
        downloadJsonBtn.addEventListener("click", () => {
          if (!currentProjectData) {
            setStatus("No project loaded to download JSON.", true);
            return;
          }
          const blob = new Blob(
            [JSON.stringify(currentProjectData, null, 2)],
            { type: "application/json" }
          );
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          const name = currentProjectData.name
            ? currentProjectData.name.replace(/[^a-z0-9\-]+/gi, "_").toLowerCase()
            : "project";
          a.download = `${name}_report.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }
    }

    async function init() {
      const projectId = getProjectIdFromURL();
      if (!projectId) {
        setStatus("Missing projectId in URL. Go back to the dashboard and open a project from there.", true);
        return;
      }
      currentProjectId = projectId;

      // Back button
      if (backToProjectBtn) {
        backToProjectBtn.addEventListener("click", () => {
          window.location.href = `project.html?projectId=${encodeURIComponent(projectId)}`;
        });
      }

      // Make breadcrumb project clickable
      const breadcrumbProjectLink = document.createElement("a");
      breadcrumbProjectLink.href = `project.html?projectId=${encodeURIComponent(projectId)}`;
      breadcrumbProjectLink.textContent = "Project";
      if (breadcrumbProject && breadcrumbProject.parentNode) {
        breadcrumbProject.replaceWith(breadcrumbProjectLink);
      }

      setupButtons();
      await loadProject(projectId);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>